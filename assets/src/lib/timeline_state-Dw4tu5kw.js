import{aD as C,aE as E,aF as D,aC as A}from"../../vendor-6J9SHA5K.js";import{d as g}from"./data_store-DFUoucx7.js";import{h as v,f as T,d as h,c as O}from"./consts-Cj2W_VlV.js";import{s as S,v as k,b as B,d as u,e as b,f as P,h as V,i as w,r as x,c as F}from"./helpers-CGQdiVDq.js";import{a as j}from"../logic/export_logic-zYbLsDjC.js";const Z=C()(E((l,a)=>({phoneModel:"NP1",items:{0:[],1:[],2:[],3:[],4:[]},clipboard:[],isCutActive:!1,audioInformation:{durationInMilis:0,title:""},appSettings:{isZoneVisible:!1,isKeyboardGestureEnabled:!0,isMultiSelectActive:!1,timelinePixelFactor:160,isSettingsDialogOpen:!1,settingDialogContentIndex:0,showAudioTimeStamp:!1,bpmValue:60,snapToBpmActive:!1,alsoSnapDuration:!1,snapSensitivity:15,showHeavyUi:!1},toggleZoneVisibility:()=>l(i=>({appSettings:{...i.appSettings,isZoneVisible:!i.appSettings.isZoneVisible}})),toggleShowAudioTimeStamp:()=>l(i=>({appSettings:{...i.appSettings,showAudioTimeStamp:!i.appSettings.showAudioTimeStamp}})),toggleShowShowHeavyUi:()=>l(i=>({appSettings:{...i.appSettings,showHeavyUi:!i.appSettings.showHeavyUi}})),setIsSettingsDialogOpen:i=>{l({appSettings:{...a().appSettings,isSettingsDialogOpen:i,isKeyboardGestureEnabled:!i}})},setSettingsDialogContentIndex:i=>{l({appSettings:{...a().appSettings,settingDialogContentIndex:i}})},toggleKeyboardGesture:i=>{l(i?t=>({appSettings:{...t.appSettings,isKeyboardGestureEnabled:i}}):t=>({appSettings:{...t.appSettings,isKeyboardGestureEnabled:!t.appSettings.isKeyboardGestureEnabled}}))},toggleMultiSelect:i=>l(t=>({appSettings:{...t.appSettings,isMultiSelectActive:i??!t.appSettings.isMultiSelectActive}})),toggleSnapToBpm:()=>l(i=>({appSettings:{...i.appSettings,snapToBpmActive:!i.appSettings.snapToBpmActive}})),toggleAlsoSnapBlockDuration:()=>l(i=>({appSettings:{...i.appSettings,alsoSnapDuration:!i.appSettings.alsoSnapDuration}})),setBpmForSnap:i=>{if(i<1||i>700){S("Invalid Value - BPM","BPM must be between 1 and 700.");return}l(t=>({appSettings:{...t.appSettings,bpmValue:i}}))},setSnapSensitivity:i=>{if(i<13||i>25){S("Invalid Value - Snap Sensitivity","BPM range is between 13 and 25. Invserve Sensitivity value not updated.",1500);return}l(t=>({appSettings:{...t.appSettings,snapSensitivity:i}}))},decreasePixelFactor:()=>{const t=a().appSettings.timelinePixelFactor/1.5,e={...a().appSettings,timelinePixelFactor:t};l({appSettings:e})},increasePixelFactor:()=>{const t=a().appSettings.timelinePixelFactor*1.5,e={...a().appSettings,timelinePixelFactor:t};l({appSettings:e})},updateAudioDuration:i=>l(t=>({audioInformation:{...t.audioInformation,durationInMilis:i}})),importJsonData:i=>{const t=JSON.parse(i);if(k(t)){const e=Object.keys(t).length;if(Object.keys(a().items).length!==e){S("Import Error - Phone Model Mismatch",`Are you sure correct Phone model is selected? ${v[e]?`Hint: Try with ${v[e].toUpperCase()}`:""}`,2800);return}const s=B(t);async function r(o){setTimeout(()=>{const n=x(o,a().audioInformation.durationInMilis);l({items:n})},100)}r(s)}else S("Import Error - Glyph data","Format error in Glyph data detected, skipping import.",2100)},addItemDirectly:i=>{const{items:t,audioInformation:e}=a(),s=r=>{l(o=>({items:{...o.items,[i.glyphId]:w(o.items[i.glyphId],r)}}))};if(u(i,t[i.glyphId],e.durationInMilis,-1,!0))s(i),a().toggleSelection(i);else{const r={...i,startTimeMilis:i.startTimeMilis-200};u(r,t[i.glyphId],e.durationInMilis)&&(s(r),a().toggleSelection(r))}},addItem:(i,t)=>{const e=b(i,t);a().addItemDirectly(e)},removeItem:(i,t)=>l(e=>({items:{...e.items,[t]:e.items[t].filter(s=>s.id!==i)}})),updateSelectedItem:i=>{const t=a().items,{snapToBpmActive:e,alsoSnapDuration:s,bpmValue:r,snapSensitivity:o}=a().appSettings,n={...t},m=a().audioInformation.durationInMilis;for(let c=0;c<Object.keys(n).length;c++)for(let p=0;p<n[c].length;p++){let d={...n[c][p]};if(d.isSelected){if(d={...d,startTimeMilis:d.startTimeMilis+(i.startTimeMilis??0),durationMilis:d.durationMilis+(i.durationMilis??0),effectId:i.effectId??d.effectId??0,startingBrightness:i.startingBrightness??d.startingBrightness??T},e){const I=F(r),M=g.get("startTimeAccumulator"),f=o;if(i.durationMilis)if(s){const y=i.durationMilis>0?"right":"left";d.durationMilis=P(d.durationMilis,I,y),g.set("durationAccumulator",0),u(d,n[c],m,p)&&(n[c][p]=d)}else u(d,n[c],m,p)&&(n[c][p]=d);if(i.startTimeMilis&&(g.set("startTimeAccumulator",M+1),M>=f)){const y=i.startTimeMilis>0?"right":"left";d.startTimeMilis=P(d.startTimeMilis,I,y),g.set("startTimeAccumulator",0),u(d,n[c],m,p)&&(n[c][p]=d)}}else u(d,n[c],m,p)&&(n[c][p]=d);if(i.effectId||i.durationMilis||i.startingBrightness){const I=[],M=Math.floor(d.durationMilis/h);for(let f=0;f<Math.floor(d.durationMilis/h);f++)I.push(0);for(let f=0;f<M;f++)I[f]=j(d.effectId,d.startingBrightness,f,M);n[c][p].effectData=I}}}l({items:n})},updateSelectedItemAbsolutely:i=>{const e={...a().items},s=a().audioInformation.durationInMilis;for(let r=0;r<Object.keys(e).length;r++)for(let o=0;o<e[r].length;o++){let n={...e[r][o]};if(n.isSelected){if(n={...n,startTimeMilis:i.startTimeMilis??n.startTimeMilis??0,durationMilis:i.durationMilis??n.durationMilis??g.get("newBlockDurationMilis"),effectId:i.effectId??n.effectId??0,startingBrightness:i.startingBrightness??n.startingBrightness??g.get("newBlockBrightness")},i.effectId||i.durationMilis||i.startingBrightness){const m=[],c=Math.floor(n.durationMilis/h);for(let p=0;p<Math.floor(n.durationMilis/h);p++)m.push(0);for(let p=0;p<c;p++)m[p]=j(n.effectId,n.startingBrightness,p,c);n.effectData=m}V(n,e[r],s,o)&&(e[r][o]=n)}}l({items:B(e)})},fillEntireZone:(i,t,e)=>{const{items:s,audioInformation:r}=a(),o={...s};a().selectAll(!1);for(let n=i;n<=t;n++){const m=b(n,e);u(m,s[n],r.durationInMilis)&&(o[n]=w(o[n],m))}l({items:o})},toggleSelection:(i,t=!0)=>{const{items:e,appSettings:s}=a(),r={...e};if(!s.isMultiSelectActive)for(let m=0;m<Object.keys(r).length;m++)for(let c=0;c<r[m].length;c++)r[m][c].isSelected=!1;const n=r[i.glyphId].find(m=>m.id===i.id);n&&(n.isSelected=t,l({items:r}))},reset:()=>{const i={NP1:5,NP1_15:15,NP2:33,NP2a:26}[a().phoneModel]??5;l({items:Array.from({length:i},()=>[]),clipboard:[]})},copyItems:()=>{const i=a().items,t=[];for(let e=0;e<Object.keys(i).length;e++)for(let s=0;s<i[e].length;s++){const r={...i[e][s]};r.isSelected&&t.push(r)}l({clipboard:t}),t.length>500?S(`Copied Items Count - ${t.length}`,"This is allowed but may slow down the app, for real!",1500):S("Items Copied","Selected items have been copied.")},cutItems:()=>{const i=a().items,t=[];for(let e=0;e<Object.keys(i).length;e++)for(let s=0;s<i[e].length;s++){const r={...i[e][s]};r.isSelected&&t.push(r)}a().removeSelectedItem(),l({clipboard:t,isCutActive:!0}),S("Items Cut","Selected items have been cut.")},pasteItems:()=>{const i=a().clipboard,t=g.get("currentAudioPositionInMilis")??0;let e=999999999,s=-1;for(let o=0;o<i.length;o++)i[o].startTimeMilis<e&&(e=i[o].startTimeMilis,s=o);const r=e;for(let o=0;o<i.length;o++){const n=g.get("overwriteBrightnessWithNewBlock")??!1?g.get("newBlockBrightness")??i[o].startingBrightness:i[o].startingBrightness;if(o===s){const c={...i[o],id:A(),startingBrightness:n,startTimeMilis:t};a().addItemDirectly(c)}else{const c={...i[o],id:A(),startingBrightness:n,startTimeMilis:t+(i[o].startTimeMilis-r)};a().addItemDirectly(c)}a().isCutActive&&l({clipboard:[],isCutActive:!1})}},addGlyphItemDirectly:i=>{const t=a().items,e=a().audioInformation,s={...i,id:A()};function r(o){const n={...t,[s.glyphId]:[...t[s.glyphId],o]};l({items:n}),a().toggleSelection(o)}if(u(s,t[s.glyphId],e.durationInMilis))r(s);else{const o={...s,startTimeMilis:s.startTimeMilis-200};u(o,t[s.glyphId],e.durationInMilis)&&r(o)}},removeSelectedItem:()=>{const i=a().items;let t={...i};function e(s,r){t={...t,[r]:t[r].filter(o=>o.id!==s)}}for(let s=0;s<Object.keys(i).length;s++)for(let r=0;r<i[s].length;r++){const o=i[s][r];o.isSelected&&e(o.id,o.glyphId)}l({items:t})},selectAll:(i=!0)=>{const e={...a().items};for(let s=0;s<Object.keys(e).length;s++)for(let r=0;r<e[s].length;r++)e[s][r].isSelected=i;l({items:e})},changePhoneModel:i=>{if(!O.find(e=>e===i)){console.error("Error Phone Model - Wrong option detected!");return}l({phoneModel:i}),a().reset()},generateGlyphs:i=>{const t=a().items,e=a().audioInformation,s={...t},r=i.generationDurationMilis+i.generationGapMilis;if(i.generationGlyphZone===101)for(let o=i.generationStartTimeMilis;o<i.generationEndTimeMilis;o=o+r)for(let n=0;n<Object.keys(t).length;n++){const m=b(n,o,i.generationDurationMilis,i.generationBlockBrightnessPercentage/100*T,i.generationBlockEffectId);u(m,s[n],e.durationInMilis)&&(s[n]=[...w(s[n],m)])}else for(let o=i.generationStartTimeMilis;o<i.generationEndTimeMilis;o=o+r){const n=b(i.generationGlyphZone,o,i.generationDurationMilis,i.generationBlockBrightnessPercentage/100*T,i.generationBlockEffectId);u(n,s[i.generationGlyphZone],e.durationInMilis)&&(s[i.generationGlyphZone]=[...w(s[i.generationGlyphZone],n)])}l({items:s})}}),{partialize:l=>{const{items:a}=l;return{items:a}}})),$=(l,a)=>D(Z.temporal,l,a);export{$ as a,Z as u};
